<!DOCTYPE html>
<meta charset="utf-8">
<html>
    <style>

    body {
        font-size: 12px;
    }

    rect {
      fill: none;
      pointer-events: all;
    }

    .node {
        /*fill: #ccc;
        stroke: #f00;*/
        /* stroke: #fff;
        stroke-width: 2px;*/
        border-color: #f00;
        stroke-width: 8;
    }

    .link {
      stroke: #999;
      stroke-width: 1;
    }

    table {
        border-spacing: 0 0;
        border-collapse: separate;
        fixed-layout: fixed;
        width: 200px;
    }

    th, td {
        padding: 0 10px;
        width: 100px;
        background-color: #eee;
    }

    table, th {
        border: 1px solid grey;
    }

    td {
        border: 1px dashed grey;
    }

    </style>
    <body>
        <script src="//d3js.org/d3.v3.min.js"></script>
        <script src="/data.js"></script>
        <script>
        var columns = ["Tag","Value"];
        var width = window.innerWidth,
            height = window.innerHeight;

        var svg = d3.select("body").append("svg")
            .attr("width", width)
            .attr("height", height);
            //.on("mousemove", mousemove)
            //.on("mousedown", mousedown);

        var links = [];
        data.forEach(function(src) {
            data.forEach(function(dst) {
                src.table.forEach(function(srcDict, srcidx) {
                    dst.table.forEach(function(dstDict, dstidx) {
                        var srcTag = srcDict.Tag;
                        var dstTag = dstDict.Tag;
                        var srcVal = srcDict.Value;
                        var dstVal = dstDict.Value;
                        //console.log(typeof srcVal);
                        if (dstTag == "id" && srcVal == dstVal && srcTag != "id") {
                            links.push({source: src, target: dst, label: srcTag});
                        } else if (typeof srcVal === "object") {
                            //console.log(srcVal);
                            for (var key in srcVal) {
                                if (srcVal[key] == dstVal && srcTag != "id" && dstTag == "id") {
                                    links.push({source: src, target: dst, label: srcTag});
                                    break;
                                }
                            }
                        }
                    });
                });
            });
        });

		var force = d3.layout.force()
			.size([width, height])
			.nodes(data)
            .links(links)
            .gravity(0.1)
            .chargeDistance(500)
			.linkDistance(400)
            .linkStrength(0.2)
            .charge(-3000);
        var node_drag = d3.behavior.drag()
            .on("dragstart", dragstart)
            .on("drag", dragmove)
            .on("dragend", dragend);

        // drag behavior from http://bl.ocks.org/norrs/2883411
        function dragstart(d, i) {
            force.stop() // stops the force auto positioning before you start dragging
        }

        function dragmove(d, i) {
            d.px += d3.event.dx;
            d.py += d3.event.dy;
            d.x += d3.event.dx;
            d.y += d3.event.dy; 
            tick({"alpha":0}); // this is the key to make it work together with updating both px,py,x,y on d !
        }

        function dragend(d, i) {
            d.fixed = true; // of course set the node to fixed so the force doesn't include the node in its auto positioning stuff
            tick({"alpha":0});
            //force.resume();
        }

        var link = svg.selectAll('.link')
                      .data(links)
                      .enter()
                      .append("line")
                      .attr("class","link")
                      .attr('marker-end','url(#arrowhead)');


        var edgepaths = svg.selectAll(".edgepath")
                        .data(links).enter()
                        .append('path')
                        .attr('class','edgepath')
                        .attr('fill-opacity',0)
                        .attr('stroke-opacity',0)
                        .attr('id', function(d,i) { return 'edgepath'+i })
                        .style('pointer-events','none');

        var edgelabels = svg.selectAll(".edgelabel")
                        .data(links).enter()
                        .append("text")
                        .style("pointer-events", "none")
                        .attr("class", "edgelabel")
                        .attr("id", function(d,i) { return 'edgelabel'+i; })
                        .attr('font-size', 20)
                        .attr("fill", "#000");
                                //'x': function(d) { if (d.target.x > d.source.x) { return d.source.x + (d.source.x + d.target.x)/2 } else { return d.target.x + (d.target.x-d.source.x)/2} },
                                //'y': function(d) { if (d.target.y > d.source.y) { return d.source.y + (d.source.y + d.target.y)/2 } else { return d.target.y + (d.target.y-d.source.y)/2} },
        edgelabels.append('textPath')
                    .attr('xlink:href',function(d,i) {return '#edgepath'+i})
                    .style('text-anchor','middle')
                    .style('pointer-events','none')
                    .attr('startOffset','50%')
                    .text(function(d,i){return d.label; });

        console.log(edgelabels);
        var node = svg.selectAll('.node')
                      .data(data).enter()
                      .append("foreignObject")
                      .attr("x", function(node) { return node.x; })
                      .attr("y", function(node) { return node.y; })
                      .attr("class", "node")
                      .call(node_drag)
                      .html(function(node) {
                        var table = d3.select(document.createElement("g"));
                        var rows = table.append('table').append('tbody').selectAll("tr")
                                .data(node.table).enter().append("tr");

                        rows.selectAll('td').data(function(row) {
                            //console.log(row);
                            return columns.map(function(column) {
                                    return {column: column, value: row[column]};
                            });
                        }).enter().append('td')
                          .text(function(d) {return d.value == "true" || d.value == "True" ? "" : d.value })
                          .style("font-weight", function(d) { return d.column == "Tag" ? "bold" : ""; });
                        //table.style('background-color','#fff');
                        return table.html();
                      });
        svg.append('defs').append('marker')
            .attr('id','arrowhead')
            .attr('viewBox','-0 -5 10 10')
            .attr('refX',13)
            .attr('refY',0)
            .attr('orient','auto')
            .attr('markerWidth',13)
            .attr('markerHeight',13)
            .attr('xoverflow','visible')
            .append('svg:path')
            .attr('d', 'M 0,-5 L 10 ,0 L 0,5')
            .attr('fill', '#999')
            .style('stroke','none');

        svg.append('defs').append('marker')
            .attr('id','arrowheadhighlight')
            .attr('viewBox','-0 -5 10 10')
            .attr('refX',13)
            .attr('refY',0)
            .attr('orient','auto')
            .attr('markerWidth',13)
            .attr('markerHeight',13)
            .attr('xoverflow','visible')
            .append('svg:path')
            .attr('d', 'M 0,-5 L 10 ,0 L 0,5')
            .attr('fill', '#ff817b')
            .style('stroke','none');


        node.on('mouseover', function(d) {
            d3.select(this).selectAll('td').style('background-color', '#ff817b');

            link.style('stroke', function(l) {
                if (d === l.source || d === l.target)
                    return '#ff817b';
                else
                    return '#000';
            });
            link.attr('marker-end', function(l) {
                if (d === l.source || d === l.target)
                    return 'url(#arrowheadhighlight)';
                else
                    return 'url(#arrowhead)';
            });
        });
        node.on('mouseout', function(d) {
            d3.select(this).selectAll('td').style('background-color', '#eee');
            link.style('stroke', function(l) {
                    return '#000';
            });
            link.attr('marker-end', function(l) {
                    return 'url(#arrowhead)';
            });
        });

        //console.log(link);
        var tick = function(a) {
            link.attr("x1", function(d) { return d.source.x; })
                .attr("y1", function(d) { return d.source.y; }) // 36 is 1.5 lines
                .attr("x2", function(d) { return d.target.x; })
                .attr("y2", function(d) { return d.target.y; });
            node.attr('x', function(d) { return d.x; })
                .attr('y', function(d) { return d.y; });
            edgepaths.attr('d', function (d) {
                return 'M ' + d.source.x + ' ' + d.source.y + ' L ' + d.target.x + ' ' + d.target.y;
            });

            //edgelabels.attr('x', function(d) { return d.source.x })
            //          .attr('y', function(d) { return d.source.y });
            edgelabels.attr('transform',function(d,i){
                    if (d.target.x<d.source.x){
                        bbox = this.getBBox();
                        rx = bbox.x+bbox.width/2;
                        ry = bbox.y+bbox.height/2;
                        return 'rotate(180 '+rx+' '+ry+')';
                    } else {
                        return 'rotate(0)';
                    }
            });
        };

        force.on('tick', tick);
        force.on('end', function(a) {
            force.stop();
        });

        force.start();

        </script>
    </body>
</html>
